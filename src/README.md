# T-Bank CSV to XLSX Converter

CLI утилита для конвертации CSV выписок Т-Банка в XLSX формат с двойной записью (double-entry bookkeeping) для импорта в Google Sheets.

## Возможности

- Парсинг специфического формата CSV от Т-Банка (разделитель `;`, 15 колонок)
- Автоматическая категоризация расходов на основе настраиваемых правил
- Автоматическое объединение парных переводов между своими счетами
- Формат двойной записи: дебет/кредит, категории, подкатегории
- Маппинг номеров карт в названия счетов
- Маппинг описаний переводов в целевые счета
- Категоризация доходов по описанию
- Настраиваемый символ валюты

## Установка

Проект использует [uv](https://github.com/astral-sh/uv) для управления зависимостями.

```bash
# Установить uv (если еще не установлен)
curl -LsSf https://astral.sh/uv/install.sh | sh
# или на Windows:
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# Перейти в директорию проекта
cd src

# Синхронизировать зависимости (создаст .venv автоматически)
uv sync

# Для разработки (с тестами):
uv sync --extra dev
```

## Использование

### Базовая команда

```bash
uv run tbank-convert -i input.csv -o output.xlsx
```

### С пользовательским конфигом

```bash
uv run tbank-convert -i input.csv -o output.xlsx -c configs/my_config.yaml
```

### Пример вывода

```
Converting T-Bank CSV to XLSX...

[SUCCESS] Conversion completed!
  Operations processed: 107
  Period: 01.01.2026 - 31.01.2026
  Categories used: 12
  Output: D:\output.xlsx
```

## Структура XLSX файла

### Колонки (9 штук, формат двойной записи)

| Колонка | Описание |
|---------|----------|
| Дата | Дата операции (YYYY-MM-DD) |
| Дебет (Куда) | Счёт-получатель (куда приходят деньги) |
| Кредит (Откуда) | Счёт-источник (откуда уходят деньги) |
| Сумма | Сумма операции (всегда положительная, с символом валюты) |
| Валюта | Код валюты (RUB, USD и т.д.) |
| Описание | Описание операции из банка |
| Комментарий | Пустое поле для пользовательских заметок |
| Категория | Категория расхода/дохода |
| Подкатегория | Подкатегория |

### Типы операций

**Расход** (сумма < 0):
- Дебет = "расходы" (служебный счёт)
- Кредит = название вашего счёта
- Категория и подкатегория заполняются автоматически

**Доход** (сумма > 0, не перевод):
- Дебет = название вашего счёта
- Кредит = "доходы" (служебный счёт)
- Категория из income_description_mapping

**Перевод** (между своими счетами):
- Дебет/Кредит заполняются из маппинга или оставляются пустыми
- Категория пустая

### Именование листов

Листы автоматически именуются по дате операций (например, "January2026").

## Конфигурация

Конфигурация хранится в YAML файле (`configs/default.yaml` по умолчанию).

### Структура конфига

```yaml
version: "1.0"

settings:
  uncategorized_label: "прочее"    # Категория для неопознанных расходов
  default_currency: "RUB"          # Валюта (определяет символ: ₽, $, €)
  date_format: "%d.%m.%Y %H:%M:%S"
  default_account: "Счет Тбанка"   # Используется при пустом номере карты
  service_accounts:
    income: "доходы"
    expense: "расходы"

# Список допустимых категорий расходов
categories:
  - "продукты"
  - "транспорт"
  - "кафе"
  # ...

# Маппинг номеров карт в названия счетов
account_mappings:
  "*1234": "Счет Тбанка"
  "*5678": "Накопительный счет"

# Маппинг категорий Т-Банка в ваши категории
# Простой (только категория):
bank_category_mapping:
  "Супермаркеты": "продукты"
  "Рестораны": "кафе"
  # С подкатегорией:
  "Заправки":
    category: "автомобиль"
    subcategory: "бензин"

# Маппинг описаний в категории расходов (приоритет выше bank_category)
description_mapping:
  "Пятёрочка": "продукты"
  "Яндекс Такси": "транспорт"

# Маппинг подкатегорий по описанию
subcategory_mappings:
  "яндекс такси": "такси"
  "пятёрочка": "еда"

# Маппинг описаний доходов в категории
income_description_mapping:
  "РОМАШКА": "зарплата"

# Маппинг описаний переводов в целевой счёт
transfer_account_mapping:
  "Пополнение брокерского счета": "ТИнвестиции"
  "Перевод на вклад": "Накопительный счет"
```

### Правила категоризации расходов

Приоритет (от высшего к низшему):

1. **Точное совпадение в description_mapping**
2. **Подстрока в description_mapping** (регистронезависимо)
3. **Маппинг банковской категории** (`bank_category_mapping`)
4. **Fallback** — значение из `settings.uncategorized_label` ("прочее")

### Объединение парных переводов

Т-Банк экспортирует переводы между своими счетами как две операции (уход и приход). Конвертер автоматически объединяет их в одну операцию с заполненными дебетом и кредитом.

Критерии объединения:
- Описание содержит "Между своими счетами"
- Суммы равны по модулю и противоположны по знаку
- Разница во времени ≤ 5 секунд

## Интеграция с Google Sheets

После конвертации:

1. Откройте Google Sheets
2. Файл → Импорт → Загрузить → Выберите output.xlsx
3. Выберите "Заменить текущий лист"

Файл готов к работе — заполняйте комментарии и корректируйте категории вручную при необходимости.

## Разработка

### Запуск тестов

```bash
uv run pytest tests/ -v
uv run pytest --cov=tbank_converter tests/
```

### Структура проекта

```
src/
├── configs/                  # Конфигурационные файлы
│   └── default.yaml
├── tbank_converter/          # Основной пакет
│   ├── cli.py               # CLI интерфейс (Click)
│   ├── pipeline.py           # Главный оркестратор
│   ├── config.py             # Pydantic-модели конфигурации
│   ├── domain/               # Бизнес-логика
│   │   ├── models.py         # Operation и Report (dataclasses)
│   │   ├── transform.py      # Парсинг CSV → типизированные объекты
│   │   └── categorization.py # Двойная запись + категоризация
│   └── io/                   # Ввод/вывод
│       ├── csv_reader.py     # Парсер CSV Т-Банка (15 колонок)
│       └── xlsx_writer.py    # Генерация Excel файлов
└── tests/                    # Тесты
    ├── helpers.py            # Фабрика make_operation()
    ├── fixtures/
    │   └── sample_tbank.csv
    ├── test_csv_reader.py
    ├── test_transform.py
    ├── test_categorization.py
    └── test_xlsx_smoke.py
```

## Требования

- Python >= 3.11
- openpyxl >= 3.1.2
- pyyaml >= 6.0.1
- pydantic >= 2.9.0
- click >= 8.1.7

## Лицензия

MIT
