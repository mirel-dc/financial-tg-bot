# T-Bank CSV to XLSX Converter

CLI утилита для конвертации CSV выписок Т-Банка в XLSX формат с автоматической категоризацией и формулами для Google Sheets.

## Возможности

- Парсинг специфического формата CSV от Т-Банка (разделитель `;`, 15 колонок)
- Автоматическая категоризация операций на основе настраиваемых правил
- Создание XLSX файла с формулами Excel для интеграции с Google Sheets
- Сводка по категориям с автоматическим подсчетом сумм и количества операций
- Поддержка ручной категоризации (пустая колонка заполняется пользователем)
- Цветная визуализация: каждая категория имеет свой цвет в таблице
- Специальная категория "Не учитывать" для операций, которые не должны входить в итоговые расчеты

## Установка

Проект использует [uv](https://github.com/astral-sh/uv) для управления зависимостями.

```bash
# Установить uv (если еще не установлен)
curl -LsSf https://astral.sh/uv/install.sh | sh
# или на Windows:
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# Перейти в директорию проекта
cd src

# Синхронизировать зависимости (создаст .venv автоматически)
uv sync

# Для разработки (с тестами):
uv sync --extra dev
```

## Использование

### Базовая команда

```bash
# С uv
uv run tbank-convert -i input.csv -o output.xlsx

# Или после активации окружения (Windows: .venv\Scripts\activate, Linux/Mac: source .venv/bin/activate)
tbank-convert -i input.csv -o output.xlsx
```

### С пользовательским конфигом

```bash
uv run tbank-convert -i input.csv -o output.xlsx -c configs/my_config.yaml
```

### Пример вывода

```
Converting T-Bank CSV to XLSX...

✓ Conversion completed!
  Operations processed: 107
  Period: 01.01.2026 - 31.01.2026
  Total income: 40000.00 ₽
  Total expense: -61234.86 ₽
  Output: D:\output.xlsx
```

## Структура XLSX файла

### Колонки (10 штук)

1. **Дата операции** - дата и время операции
2. **Описание** - описание из банка
3. **Категория банка** - исходная категория от Т-Банка
4. **Авто категория** - автоматически присвоенная категория (на основе маппинга)
5. **Ручная категория** - пустая колонка для ручного заполнения в Google Sheets
6. **Финальная категория** - формула `=IF(E2<>"", E2, D2)` (выбирает ручную или авто)
7. **Сумма операции** - сумма с форматом `#,##0.00 ₽`
8. **MCC** - код категории
9. **Номер карты** - маскированный номер карты
10. **Статус** - статус операции (OK/FAILED)

### Summary-блок

Размещается через 2 пустые строки после транзакций и содержит:

- Список всех категорий
- Формулы `SUMIF` для подсчета сумм по категориям
- Формулы `COUNTIF` для подсчета количества операций
- Итоговую строку с `SUM` формулой

## Конфигурация

Конфигурация хранится в YAML файле (`configs/default.yaml` по умолчанию).

### Структура конфига

```yaml
version: "1.0"

settings:
  uncategorized_label: "Нет категории"
  ignore_label: "Не учитывать"  # Категория для операций, не входящих в итоговые расчеты
  default_currency: "RUB"
  date_format: "%d.%m.%Y %H:%M:%S"

categories:
  - "Продукты"
  - "Рестораны"
  - "Транспорт"
  - "Не учитывать"
  # ... другие категории

# Цвета для категорий (HEX формат без #)
category_colors:
  "Продукты": "C6EFCE"
  "Рестораны": "FFC7CE"
  "Транспорт": "D9E1F2"
  "Не учитывать": "D9D9D9"
  # ... другие цвета

bank_category_mapping:
  "Супермаркеты": "Продукты"
  "Рестораны": "Рестораны"
  # ... другие маппинги

description_mapping:
  "Леонардо": "Хобби"
  "Boosty.to": "Подписки"
  "Пятёрочка": "Продукты"
  # ... другие маппинги
```

### Правила категоризации

Приоритет (от высшего к низшему):

1. **Маппинг по описанию** (`description_mapping`) - точное совпадение или substring
2. **Маппинг банковской категории** (`bank_category_mapping`)
3. **Fallback** - "Нет категории" (или значение из `settings.uncategorized_label`)

### Настройка категорий

Для добавления новой категории:

1. Откройте `configs/default.yaml`
2. Добавьте категорию в список `categories`
3. Добавьте цвет для категории в `category_colors` (HEX формат без #)
4. Добавьте маппинги в `bank_category_mapping` или `description_mapping`
5. Сохраните файл

Изменения применятся при следующем запуске утилиты.

### Цветная визуализация

Каждая категория автоматически окрашивается в свой цвет с использованием условного форматирования Excel:
- Строки операций в основной таблице окрашиваются в соответствии с категорией
- Категории в Summary-блоке также имеют соответствующий цвет
- Цвета настраиваются в конфиге через параметр `category_colors`
- **Динамическое обновление:** При изменении категории в ячейке, цвет строки автоматически обновится благодаря условному форматированию Excel
- Условное форматирование работает как в Excel, так и при импорте в Google Sheets

### Summary-таблица со всеми категориями

Summary-блок показывает все категории из конфига и автоматически обновляет расчёты:

**Как работает:**
- Отображает все категории из конфига (кроме "Не учитывать")
- Формулы SUMIF и COUNTIF работают с диапазоном $C$2:$C$1000 (до 999 строк данных)
- При добавлении/изменении категорий в столбце C, суммы автоматически пересчитываются
- Категории с нулевыми суммами тоже показываются

**Формулы:**
- Для каждой категории создаётся строка с формулами:
  - `=SUMIF($C$2:$C$1000,"Категория",$D$2:$D$1000)` для сумм
  - `=COUNTIF($C$2:$C$1000,"Категория")` для количества
- Строка ИТОГО суммирует все суммы из Summary

**Преимущества:**
- Работает во всех версиях Excel (от 2007) и Google Sheets
- Можно добавлять операции с любой категорией из конфига
- Формулы автоматически пересчитываются при изменении данных
- Надёжно и без ошибок при открытии файла

**Добавление новых категорий:**
- Для появления новой категории в Summary нужно добавить её в конфиг
- Или вручную добавить строку в Summary с нужными формулами

### Автоматическое именование листов

Листы в Excel автоматически называются по дате операций:
- Формат: "MonthYear" (например, "January2026", "February2026")
- Удобно при работе с несколькими периодами в одном файле

### Категория "Не учитывать"

Специальная категория для операций, которые не должны входить в итоговые расчеты:
- Операции с этой категорией отображаются в Excel с серой заливкой
- Категория появляется в Summary-блоке (т.к. таблица динамическая)
- Чтобы исключить её из ИТОГО:
  - Вариант 1: Вручную удалите строку с "Не учитывать" из Summary
  - Вариант 2: Измените формулу ИТОГО, вычтя сумму по этой категории
- Используйте эту категорию для служебных операций, переводов между счетами и т.п.

## Интеграция с Google Sheets

После конвертации:

1. Откройте Google Sheets
2. Файл → Импорт → Загрузить → Выберите output.xlsx
3. Выберите опцию "Заменить текущий лист"

Формулы автоматически будут работать в Google Sheets:

- Изменение значения в колонке "Ручная категория" автоматически обновит "Финальная категория"
- Суммы в Summary-блоке пересчитаются автоматически

## Разработка

### Запуск тестов

```bash
# Запуск тестов
uv run pytest tests/ -v

# С покрытием
uv run pytest --cov=tbank_converter tests/
```

### Структура проекта

```
tbank_converter/
├── configs/              # Конфигурационные файлы
│   └── default.yaml
├── tbank_converter/      # Основной пакет
│   ├── cli.py           # CLI интерфейс
│   ├── pipeline.py      # Главный оркестратор
│   ├── config.py        # Управление конфигом
│   ├── domain/          # Бизнес-логика
│   │   ├── models.py
│   │   ├── transform.py
│   │   └── categorization.py
│   ├── io/              # Ввод/вывод
│   │   ├── csv_reader.py
│   │   └── xlsx_writer.py
│   └── formulas/        # Excel формулы
│       └── builder.py
└── tests/               # Тесты
    ├── fixtures/
    │   └── sample_tbank.csv
    ├── test_csv_reader.py
    ├── test_transform.py
    ├── test_categorization.py
    └── test_xlsx_smoke.py
```

## Требования

- Python >= 3.12
- openpyxl >= 3.1.2
- pyyaml >= 6.0.1
- pydantic >= 2.9.0
- click >= 8.1.7

## Лицензия

MIT
